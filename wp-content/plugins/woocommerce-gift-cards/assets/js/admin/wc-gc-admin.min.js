!function($,S,j){$(function(){$("select#wc_gc_settings_send_as_gift_status").on("change",function(){"never"===$(this).val()?$("#wc_gc_allow_multiple_recipients").closest("tr").hide():$("#wc_gc_allow_multiple_recipients").closest("tr").show()}).trigger("change"),$(j.body).on("wc-init-datepickers",function(){$(".date-picker-field, .date-picker").datepicker({dateFormat:"yy-mm-dd",numberOfMonths:1,showButtonPanel:!0})}).trigger("wc-init-datepickers"),$(".woocommerce-gc-giftcards #delete-action").on("click",function(e){if(!S.confirm(wc_gc_admin_params.i18n_wc_delete_card_warning))return e.preventDefault(),!1}),$("#giftcards-table #doaction").on("click",function(e){if("delete"===$("#bulk-action-selector-top").val()&&!S.confirm(wc_gc_admin_params.i18n_wc_bulk_delete_card_warning))return e.preventDefault(),!1}),$("#giftcards-table #doaction2").on("click",function(e){if("delete"===$("#bulk-action-selector-bottom").val()&&!S.confirm(wc_gc_admin_params.i18n_wc_bulk_delete_card_warning))return e.preventDefault(),!1});var t,i,r,o,e,n,a=!!(n=$(".wc-gc-message-mask")).length&&(t=!1,i=n.find(".wc-gc-message-mask_placeholder"),r=n.find("#wc_gc_replace_message_cancel").hide(),o=n.find("textarea"),e=$("#edit-gift-card-form"),{hook:function(){n.on("click","#wc_gc_replace_message_action, #wc_gc_replace_message_cancel",function(e){return e.preventDefault(),t?(t=!1,o.hide(),r.hide()):(o.fadeIn("fast"),r.fadeIn("fast"),t=!0),t?i.hide():i.fadeIn("fast"),!1}),e.on("submit",function(e){return!(t&&!S.confirm(wc_gc_admin_params.i18n_wc_edit_message_warning)&&(e.preventDefault(),1))})}}),c=(a&&a.hook(),{$order_items_wrapper:$("#woocommerce-order-items"),view:!1,init:function(){this.$order_items_wrapper.length&&(this.maybe_render_refunds(),$(j).ajaxComplete(function(e,t,i){if(200===t.status&&i.data)if(-1!==i.data.indexOf("action=woocommerce_load_order_items"))c.render_refunds();else if(-1!==i.data.indexOf("action=woocommerce_delete_refund")&&t.responseJSON&&!1===t.responseJSON.success)for(var r in t.responseJSON.data.errors)S.alert(t.responseJSON.data.errors[r])}),this.$order_items_wrapper.on("click","button.add-gift-card",this.add_gift_card.bind(this)).on("click","a.delete-gift-card-item",this.delete_gift_card.bind(this)).on("click","button.configure_gift_card",{action:"configure"},this.clicked_edit_button.bind(this)).on("click","button.edit_gift_card",{action:"edit"},this.clicked_edit_button.bind(this)))},maybe_render_refunds:function(){var e=$(".wc-order-refund-items .refund-actions .do-gift-card-refund"),t=$("#order_fee_line_items .giftcards.item");!Boolean(e.length)&&0<t.length&&c.render_refunds()},render_refunds:function(){$(".wc-order-totals-items");var e,t,i=$(".wc-order-refund-items .refund-actions");$(".wc-order-refund-items .wc-order-totals");i.length&&(e=$("<button/>"),t=accounting.formatMoney(0,{symbol:woocommerce_admin_meta_boxes.currency_format_symbol,decimal:woocommerce_admin_meta_boxes.currency_format_decimal_sep,thousand:woocommerce_admin_meta_boxes.currency_format_thousand_sep,precision:woocommerce_admin_meta_boxes.currency_format_num_decimals,format:woocommerce_admin_meta_boxes.currency_format}),t=$("<span/>").addClass("wc-order-refund-amount").append('<span class="amount">'+t+"</span>"),e.attr("data-tip",wc_gc_admin_params.i18n_refund_button_tip_text),e.html(wc_gc_admin_params.i18n_refund_button_text.replace("%%amount%%",t.get(0).outerHTML)),e.addClass("button button-primary do-gift-card-refund tips"),e.tipTip({attribute:"data-tip",fadeIn:50,fadeOut:50,delay:200}),i.prepend(e),t=$("tr.wc_gc_move_row_to_refund_summary").first(),i=$(".wc-order-refund-items .wc-order-totals td.total input#refund_amount").parents("tr"),t.insertBefore(i),t.show(),(i=$("tr.wc_gc_move_row_to_refund_summary").first()).insertBefore(t.prev()),i.show(),t=$("table.wc-order-totals .label.refunded-total:not(.gift-cards-refunded-total)"),Boolean(t.length)||(i=$("table.wc-order-totals .label.refunded-total").parents("table"),Boolean(i.length)&&i.css("border-top","1px solid #999").css("padding-top","12px").css("margin-top","12px")),e.on("click",this.handle_refund_button.bind(this)))},handle_refund_button:function(e){e.preventDefault(),this.do_refund()},do_refund:function(){var e,t,i,r,o,n,a;this.block(),S.confirm(woocommerce_admin_meta_boxes.i18n_do_refund)&&(a=$("input#refund_amount").val(),e=$("input#refund_reason").val(),t=$("input#refunded_amount").val(),i=$("input#gift_card_refunded_amount").val(),r={},o={},n={},$(".refund input.refund_order_item_qty").each(function(e,t){$(t).closest("tr").data("order_item_id")&&t.value&&(r[$(t).closest("tr").data("order_item_id")]=t.value)}),$(".refund input.refund_line_total").each(function(e,t){$(t).closest("tr").data("order_item_id")&&(o[$(t).closest("tr").data("order_item_id")]=accounting.unformat(t.value,woocommerce_admin.mon_decimal_point))}),$(".refund input.refund_line_tax").each(function(e,t){var i;$(t).closest("tr").data("order_item_id")&&(i=$(t).data("tax_id"),n[$(t).closest("tr").data("order_item_id")]||(n[$(t).closest("tr").data("order_item_id")]={}),n[$(t).closest("tr").data("order_item_id")][i]=accounting.unformat(t.value,woocommerce_admin.mon_decimal_point))}),a={action:"woocommerce_gc_refund_line_items",order_id:woocommerce_admin_meta_boxes.post_id,refund_amount:a,refunded_amount:t,gift_card_refunded_amount:i,refund_reason:e,line_item_qtys:JSON.stringify(r,null,""),line_item_totals:JSON.stringify(o,null,""),line_item_tax_totals:JSON.stringify(n,null,""),restock_refunded_items:$("#restock_refunded_items:checked").length?"true":"false",security:woocommerce_admin_meta_boxes.order_item_nonce},$.ajax({url:woocommerce_admin_meta_boxes.ajax_url,data:a,type:"POST",success:function(e){!0===e.success?S.location.reload():(S.alert(e.data.error),c.reload_items())}})),this.unblock()},reload_items:function(){this.$order_items_wrapper.trigger("wc_order_items_reload")},reloaded_items:function(){this.$order_items_wrapper.trigger("wc_order_items_reloaded"),this.maybe_render_refunds()},block:function(e,t){e&&"undefined"!==e||(e=this.$order_items_wrapper);t=$.extend({},{message:null,overlayCSS:{background:"#fff",opacity:.6}},t||{});e.block(t)},unblock:function(e){(e=e&&"undefined"!==e?e:this.$order_items_wrapper).unblock()},clicked_edit_button:function(e){var t=$.WCBackboneModal.View.extend({addButton:this.clicked_done_button.bind(this)}),i=$(e.target).closest("tr.item").attr("data-order_item_id");return this.view=new t({target:"wc-modal-edit-gift-card",string:{action:"configure"===e.data.action?wc_gc_admin_params.i18n_configure_order_item:wc_gc_admin_params.i18n_edit_order_item,item_id:i}}),this.populate_form.call(this),!1},clicked_done_button:function(t){this.block(this.view.$el.find(".wc-backbone-modal-content"));var e=$.extend({},this.get_taxable_address(),{action:"wc_gc_edit_order_item_gift_card_in_order",item_id:this.view._string.item_id,fields:this.view.$el.find("input, select, textarea").serialize(),dataType:"json",order_id:woocommerce_admin_meta_boxes.post_id,security:wc_gc_admin_params.edit_gift_card_order_item_nonce});$.post(woocommerce_admin_meta_boxes.ajax_url,e,function(e){e.result&&"success"===e.result?(this.$order_items_wrapper.find(".inside").empty(),this.$order_items_wrapper.find(".inside").append(e.html),this.reloaded_items(),e.notes_html&&($("ul.order_notes").empty(),$("ul.order_notes").append($(e.notes_html).find("li"))),this.unblock(this.view.$el.find(".wc-backbone-modal-content")),this.block(),setTimeout(function(){this.unblock()}.bind(this),250),this.view.closeButton(t)):(S.alert(e.error?e.error.replace(/&quot;/g,'"'):wc_gc_admin_params.i18n_validation_error),this.unblock(this.view.$el.find(".wc-backbone-modal-content")))}.bind(this))},populate_form:function(){this.block(this.view.$el.find(".wc-backbone-modal-content"));var e={action:"wc_gc_configure_order_item_gift_card",item_id:this.view._string.item_id,dataType:"json",order_id:woocommerce_admin_meta_boxes.post_id,security:wc_gc_admin_params.edit_gift_card_order_item_nonce};$.post(woocommerce_admin_meta_boxes.ajax_url,e,function(e){var t,i;e.result&&"success"===e.result?((t=this.view.$el.find("form")).html(e.html),t.wc_gc_datepickers(),t=(e=t.find(".wc-gc-edit-code")).find('input[type="checkbox"]'),i=e.find(".wc-gc-field"),t.is(":checked")||i.show(),t.on("change",function(e){$(this).is(":checked")?i.hide():i.show()}),this.unblock(this.view.$el.find(".wc-backbone-modal-content"))):(S.alert(wc_gc_admin_params.i18n_form_error),this.unblock(this.view.$el.find(".wc-backbone-modal-content")),this.view.$el.find(".modal-close").trigger("click"))}.bind(this))},add_gift_card:function(e){var t,i,r=S.prompt(wc_gc_admin_params.i18n_wc_add_order_item_prompt);return null!==r&&""!==r&&(this.block(),t=$("#customer_user").val(),i=$("#_billing_email").val(),r=$.extend({},this.get_taxable_address(),{action:"wc_gc_add_order_item_gift_card",dataType:"json",order_id:woocommerce_admin_meta_boxes.post_id,security:woocommerce_admin_meta_boxes.order_item_nonce,giftcard:r,user_id:t,user_email:i}),$.ajax({url:woocommerce_admin_meta_boxes.ajax_url,data:r,type:"POST",success:function(e){e.result&&"success"===e.result?(this.$order_items_wrapper.find(".inside").empty(),this.$order_items_wrapper.find(".inside").append(e.html),e.notes_html&&($("ul.order_notes").empty(),$("ul.order_notes").append($(e.notes_html).find("li"))),this.reloaded_items(),this.unblock()):S.alert(e.data.error),this.unblock()}.bind(this)})),e.preventDefault(),!1},delete_gift_card:function(e){var t=$(e.target).closest("tr.item, tr.fee, tr.shipping"),i=t.attr("data-gc_code"),t=t.attr("data-order_item_id");return S.confirm(wc_gc_admin_params.i18n_wc_delete_order_item_warning.replace("%%code%%",i))&&(this.block(),i=$.extend({},this.get_taxable_address(),{order_id:woocommerce_admin_meta_boxes.post_id,order_item_ids:t,action:"wc_gc_remove_order_item_gift_card",security:woocommerce_admin_meta_boxes.order_item_nonce}),"true"===$("button.cancel-action").attr("data-reload")&&(i.items=$("table.woocommerce_order_items :input[name], .wc-order-totals-items :input[name]").serialize()),$.ajax({url:woocommerce_admin_meta_boxes.ajax_url,data:i,type:"POST",success:function(e){e.result&&"success"===e.result?(this.$order_items_wrapper.find(".inside").empty(),this.$order_items_wrapper.find(".inside").append(e.html),e.notes_html&&($("ul.order_notes").empty(),$("ul.order_notes").append($(e.notes_html).find("li"))),this.reloaded_items(),this.unblock()):S.alert(e.data.error),this.unblock()}.bind(this)})),e.preventDefault(),!1},get_taxable_address:function(){var e="",t="",i="",r="";return"shipping"===woocommerce_admin_meta_boxes.tax_based_on&&(e=$("#_shipping_country").val(),t=$("#_shipping_state").val(),i=$("#_shipping_postcode").val(),r=$("#_shipping_city").val()),"billing"!==woocommerce_admin_meta_boxes.tax_based_on&&e||(e=$("#_billing_country").val(),t=$("#_billing_state").val(),i=$("#_billing_postcode").val(),r=$("#_billing_city").val()),{country:e,state:t,postcode:i,city:r}},core:{init_tiptip:function(){$("#tiptip_holder").removeAttr("style"),$("#tiptip_arrow").removeAttr("style"),$(".tips").tipTip({attribute:"data-tip",fadeIn:50,fadeOut:50,delay:200})},stupidtable:{init:function(){$(".woocommerce_order_items").stupidtable(),$(".woocommerce_order_items").on("aftertablesort",this.add_arrows)},add_arrows:function(e,t){var i=$(this).find("th"),r="asc"===t.direction?"&uarr;":"&darr;",t=t.column;i.find(".wc-arrow").remove(),i.eq(t).append('<span class="wc-arrow">'+r+"</span>")}}}});function s(o,e){!1!==o&&(o=!0),(e=e||k.find(".show_if_giftcard")).each(function(e){var t=$(this),i=t.find(".show_if_giftcard_simple"),r=t.find(".show_if_giftcard_variable");o?t.show():t.hide(),"simple"===p&&(o?r.hide():r.show(),i.length)&&(o?i.show():i.hide()),"variable"===p&&(o?i.hide():i.show(),r.length)&&(o?r.show():r.hide())})}function d(e){s(),$("#giftcard_settings").prevAll(".options_group:visible:first").addClass("gc_previous_section"),l.prop("checked","checked").trigger("change"),m.attr("class","tips"),m.hide(),e&&"undefined"!=e||h.val("none"),w.length&&w.find(".variable_is_virtual").prop("checked","checked").each(function(){var e=$(this);e.trigger("change"),e.parent().hide()})}function _(e){s(!1),$("#giftcard_settings").prevAll(".options_group:visible:first").removeClass("gc_previous_section"),m.attr("class",f.join(" ")),l.prop("checked",u?"checked":null).trigger("change"),-1!==$.inArray("show_if_"+p,f)&&m.show(),e&&"undefined"!=e||h.val(g),w.length&&w.find(".variable_is_virtual").each(function(){$(this).parent().show()})}c.init();var l,m,u,f,p,h,g,w,b,v,x,k=$("div#woocommerce-product-data");function y(){k.find(".template_default_image_container").each(function(e){var t=$(this),i=t.find("#_gift_card_template_default_use_image"),r=t.find(".gift_card_template_default_custom_image"),o=t.find(".wc_gc_field_select_image"),t=t.find(".wc_gc_field_remove_image"),n=("custom"===i.val()&&r.show(),i.on("change",function(){"custom"===i.val()?r.show():r.hide()}),t.on("click",function(e){var t=$(this),i=t.closest(".wc_gc_select_image"),r=i.find(".wc_gc_field_select_image");e.preventDefault(),r.removeClass("has_image"),t.removeClass("has_image"),i.find("input").val("").trigger("change"),r.find("img").eq(0).attr("src",wc_gc_admin_params.wc_placeholder_img_src)}),null);o.on("click",function(e){e.preventDefault();var i=$(this);n||(n=wp.media({title:wc_gc_admin_params.i18n_select_image_frame_title,button:{text:wc_gc_admin_params.i18n_select_image_frame_button},states:[new wp.media.controller.Library({title:wc_gc_admin_params.i18n_select_image_frame_title,filterable:"all"})]})).on("select",function(){var e=n.state().get("selection").first().toJSON(),t=(e.sizes&&e.sizes.thumbnail?e.sizes.thumbnail:e).url;i.addClass("has_image"),i.closest(".wc_gc_select_image").find(".wc_gc_field_remove_image").addClass("has_image"),i.find("input").val(e.id).trigger("change"),i.find("img").eq(0).attr("src",t)}),n.open()})})}k.length&&(l=k.find("#_virtual"),m=l.parent(),u=l.is(":checked"),f=m.attr("class").split(/\s+/),a=k.find("#product-type"),p=a.val(),h=k.find("#_tax_status"),g=h.val(),w=k.find("#variable_product_options"),b=k.find("#_gift_card"),v=b.parent(),x=v.attr("class").split(/\s+/),(b.is(":checked")?d:_)(!0),k.on("woocommerce_variations_loaded woocommerce_variations_added",function(){b.is(":checked")?w.find(".variable_is_virtual").prop("checked","checked").each(function(){var e=$(this);e.trigger("change"),e.parent().hide()}):s(!1),y()}),b.on("change",function(){($(this).is(":checked")?d:_)()}),a.on("change",function(){p=$(this).val(),-1===$.inArray("show_if_"+p,x)?(v.hide(),s(!1)):b.is(":checked")?s():s(!1)}),y()),D.init()}),$.fn.wc_gc_datepickers=function(){$(this).find(".datepicker").each(function(e){var t,i=$(this),r=i.parent().find('input[name="wc_gc_giftcard_delivery"]'),o=(i.datepicker({beforeShow:function(e,t){$("#ui-datepicker-div").removeClass("wc_gc_datepicker"),$("#ui-datepicker-div").addClass("wc_gc_datepicker")},minDate:"+1D"}),i.datepicker("getDate"));null!==o&&"function"==typeof o.getTime&&(t=new Date,o.setHours(t.getHours(),t.getMinutes()),r.val(o.getTime()/1e3)),i.on("change",function(){var e,t=i.datepicker("getDate");null!==t&&"function"==typeof t.getTime?(e=new Date,t.setHours(e.getHours(),e.getMinutes()),r.val(t.getTime()/1e3)):r.val("")})})};function i(e){this.$form=e,this.is_exporting=!1,this.canceled=!1,this.processStep=this.processStep.bind(this),this.onSubmit=this.onSubmit.bind(this),this.$form.find(".woocommerce-exporter-progress").val(0),e.on("click",".woocommerce-exporter-button",this.onSubmit)}i.prototype.onSubmit=function(e){e.preventDefault();e=new Date,e="wc-gc-giftcards-export-"+e.getDate()+"-"+(e.getMonth()+1)+"-"+e.getFullYear()+"-"+e.getTime()+".csv";this.$form.addClass("woocommerce-exporter__exporting"),this.$form.find(".woocommerce-exporter-button").prop("disabled",!0),this.$form.find(".woocommerce-exporter-progress").val(0),this.processStep(1,[],"",e)},i.prototype.cancel=function(e,t,i,r){this.is_exporting=!1,this.canceled=!0};var D={view:!(i.prototype.processStep=function(e,t,i,r){var o,n=$("#woocommerce-exporter-meta:checked").length?1:0,a=$("#woocommerce-exporter-filtered:checked").length?1:0;a&&(filters={date:!(!(o=function(e){e=e.split("+").join(" ");var t,i={},r=/[?&]?([^=]+)=([^&]*)/g;for(;t=r.exec(e);)i[decodeURIComponent(t[1])]=decodeURIComponent(t[2]);return i}(j.location.search)).m||0==o.m)&&parseInt(o.m,10),customer:!!o._redeemed_filter&&parseInt(o._redeemed_filter,10),search:o.s||!1,status:o.status||!1}),$.ajax({type:"POST",url:wc_gc_admin_params.wc_ajax_url,data:{form:t,action:"woocommerce_gc_do_ajax_giftcards_export",step:e,export_meta:n,export_filters:a,date_filter:!(!a||!filters)&&filters.date,customer_filter:!(!a||!filters)&&filters.customer,status_filter:!(!a||!filters)&&filters.status,search_filter:!(!a||!filters)&&filters.search,filename:r,security:wc_gc_admin_params.export_giftcards_nonce},dataType:"json",success:function(e){e.success&&("done"===e.data.step?(this.is_exporting=!1,S.location=e.data.url,this.$form.find(".woocommerce-exporter-progress").val(e.data.percentage),setTimeout(function(){this.$form.removeClass("woocommerce-exporter__exporting"),this.$form.find(".woocommerce-exporter-button").prop("disabled",!1),this.$form.find(".woocommerce-exporter-progress").val(0)}.bind(this),2e3)):(this.is_exporting=!0,this.$form.find(".woocommerce-exporter-button").prop("disabled",!0),this.$form.find(".woocommerce-exporter-progress").val(e.data.percentage),this.canceled?(this.canceled=!1,this.is_exporting=!1,setTimeout(function(){this.$form.removeClass("woocommerce-exporter__exporting"),this.$form.find(".woocommerce-exporter-progress").val(0),this.$form.find(".woocommerce-exporter-button").prop("disabled",!1)}.bind(this),2e3)):this.processStep(parseInt(e.data.step,10),[],"",r)))}.bind(this)}).fail(function(e){S.console.log(e)})}),export_form:!1,init:function(){$(".woocommerce-gc-giftcards").on("click",".woocommerce-gc-exporter-button",this.open.bind(this))},open:function(e){e.preventDefault();e=$.WCBackboneModal.View.extend({closeButton:this.cancel_export.bind(this)});return this.view=new e({target:"wc-gc-export-giftcards",string:{action:wc_gc_admin_params.i18n_export_modal_title}}),this.populate_form.call(this),!1},cancel_export:function(e){!1===this.export_form||this.export_form.canceled||this.export_form.cancel(),e.preventDefault(),$(j.body).trigger("wc_backbone_modal_before_remove",this.view._target),this.view.undelegateEvents(),$(j).off("focusin"),$(j.body).css({overflow:"auto"}),this.view.remove(),$(j.body).trigger("wc_backbone_modal_removed",this.view._target)},populate_form:function(){this.block(this.view.$el.find(".wc-backbone-modal-content"));var e={action:"wc_gc_export_modal_html",dataType:"json",security:wc_gc_admin_params.modal_export_giftcards_nonce};$.post(wc_gc_admin_params.wc_ajax_url,e,function(e){var t;e.result&&"success"===e.result?((t=this.view.$el.find("form")).html(e.html),t=t.find(".woocommerce-exporter"),this.export_form=new i(t)):console.error(e.result),this.unblock(this.view.$el.find(".wc-backbone-modal-content"))}.bind(this))},block:function(e,t){e&&"undefined"!==e&&(t=$.extend({},{message:null,overlayCSS:{background:"#fff",opacity:.6}},t||{}),e.block(t))},unblock:function(e){e&&"undefined"!==e&&e.unblock()}};$.fn.wc_gc_giftcards_export_form=function(){return new i(this),this}}(jQuery,window,document);